<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - TuPhung Project Documentation</title>
  <link rel="stylesheet" href="../../css/style.css">
  <!-- Mermaid for flowcharts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.0/dist/mermaid.min.js"></script>
  <!-- Prism for code highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
</head>
<body>
  <button class="menu-toggle">â˜°</button>
  
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>TuPhung Project</h1>
    </div>
    
    <nav class="sidebar-nav">
      <div class="sidebar-section">
        <div class="sidebar-section-title">Overview</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="../../index.html" class="sidebar-subnav-link">Introduction</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../architecture.html" class="sidebar-subnav-link">Architecture</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../tech-stack.html" class="sidebar-subnav-link">Tech Stack</a>
          </li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">Frontend</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="structure.html" class="sidebar-subnav-link">Project Structure</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="auth.html" class="sidebar-subnav-link">Authentication</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="user-management.html" class="sidebar-subnav-link active">User Management</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="chat.html" class="sidebar-subnav-link">Chat System</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="kanban.html" class="sidebar-subnav-link">Kanban Board</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="calendar.html" class="sidebar-subnav-link">Calendar</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="ai-assistants.html" class="sidebar-subnav-link">AI Assistants</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="language-ai.html" class="sidebar-subnav-link">Language AI</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="state-management.html" class="sidebar-subnav-link">State Management</a>
          </li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">Backend</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="../backend/structure.html" class="sidebar-subnav-link">Project Structure</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/auth.html" class="sidebar-subnav-link">Authentication & Security</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/user-management.html" class="sidebar-subnav-link">User Management</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/database.html" class="sidebar-subnav-link">Database Design</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/api.html" class="sidebar-subnav-link">API Endpoints</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/websockets.html" class="sidebar-subnav-link">WebSockets</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../backend/speech-processing.html" class="sidebar-subnav-link">Speech Processing</a>
          </li>
        </ul>
      </div>
    </nav>
  </aside>
  
  <main class="main-content">
    <header class="content-header">
      <h1>User Management</h1>
      <p>Comprehensive documentation of the User Management system in the TuPhung Project.</p>
    </header>
    
    <section>
      <h2>Overview</h2>
      <p>
        The User Management system in the TuPhung Project provides a comprehensive solution for managing user accounts, 
        roles, permissions, and profiles. It enables administrators to create, update, and delete user accounts, 
        assign roles and permissions, and manage user-related settings.
      </p>
      
      <div class="component-card">
        <h3>Key Features</h3>
        <ul>
          <li><strong>User Registration</strong> - Self-service user registration with email verification</li>
          <li><strong>User Profiles</strong> - Detailed user profiles with customizable fields</li>
          <li><strong>Role-Based Access Control</strong> - Granular permission management through roles</li>
          <li><strong>User Administration</strong> - Administrative interface for user management</li>
          <li><strong>Account Settings</strong> - User-configurable account settings</li>
          <li><strong>Password Management</strong> - Secure password reset and change functionality</li>
          <li><strong>User Search & Filtering</strong> - Advanced search and filtering capabilities</li>
          <li><strong>User Activity Tracking</strong> - Monitoring of user actions and login history</li>
          <li><strong>Team Management</strong> - Organization of users into teams and departments</li>
        </ul>
      </div>
      
      <h2>Architecture</h2>
      
      <div class="diagram-container">
        <div class="diagram-title">User Management Architecture</div>
        <div class="mermaid">
          graph TD
            User[User] --> UI[User Management UI]
            UI --> UserList[User List]
            UI --> UserForm[User Form]
            UI --> RoleManager[Role Manager]
            
            UserList --> UserState[User State]
            UserForm --> UserState
            RoleManager --> UserState
            
            UserState --> UserService[User Service]
            UserService --> API[REST API]
            
            API --> Backend[Backend Server]
            Backend --> Database[(Database)]
            
            subgraph Frontend
              UI
              UserList
              UserForm
              RoleManager
              UserState
              UserService
            end
            
            subgraph Backend
              API
              Backend
              Database
            end
        </div>
      </div>
      
      <h2>Frontend Implementation</h2>
      
      <p>
        The User Management frontend is built using React with TypeScript and leverages Ant Design for UI components.
        The state management is handled through Redux, with a dedicated slice for user-related state.
      </p>
      
      <div class="component-card">
        <h3>Main Components</h3>
        <p>The User Management system consists of several key components:</p>
        
        <h4>1. UserManagementPage Component</h4>
        <p>
          This is the main container component that renders the user management interface. It provides tabs for 
          different user management functions such as user list, roles, and teams.
        </p>
        
        <p>Key responsibilities:</p>
        <ul>
          <li>Loading user data from the backend</li>
          <li>Managing tab navigation</li>
          <li>Coordinating user operations</li>
        </ul>
        
        <p>Example implementation:</p>
        <pre><code class="language-typescript">// UserManagementPage.tsx
import React, { useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { Tabs, Button, message } from 'antd';
import { PlusOutlined, TeamOutlined, UserOutlined, LockOutlined } from '@ant-design/icons';
import { fetchUsers, fetchRoles, fetchTeams } from '../services/userService';
import { setUsers, setRoles, setTeams } from '../store/userSlice';
import { RootState } from '../store/rootState';
import UserList from '../components/UserList';
import RoleManager from '../components/RoleManager';
import TeamManager from '../components/TeamManager';
import UserFormModal from '../components/UserFormModal';
import '../styles/UserManagement.css';

const { TabPane } = Tabs;

const UserManagementPage: React.FC = () => {
  const dispatch = useDispatch();
  const { users, roles, teams, loading } = useSelector((state: RootState) => state.user);
  const { currentUser } = useSelector((state: RootState) => state.auth);
  
  const [activeTab, setActiveTab] = useState('users');
  const [isModalVisible, setIsModalVisible] = useState(false);
  
  useEffect(() => {
    const loadData = async () => {
      try {
        const userData = await fetchUsers();
        dispatch(setUsers(userData));
        
        const roleData = await fetchRoles();
        dispatch(setRoles(roleData));
        
        const teamData = await fetchTeams();
        dispatch(setTeams(teamData));
      } catch (error) {
        console.error('Failed to load user management data:', error);
        message.error('Failed to load user data. Please try again later.');
      }
    };
    
    loadData();
  }, [dispatch]);
  
  const handleTabChange = (key: string) => {
    setActiveTab(key);
  };
  
  const handleAddUser = () => {
    setIsModalVisible(true);
  };
  
  const canManageUsers = () => {
    return currentUser?.roles.some(role => 
      role.permissions.includes('manage_users')
    );
  };
  
  return (
    &lt;div className="user-management-container"&gt;
      &lt;div className="page-header"&gt;
        &lt;h1&gt;User Management&lt;/h1&gt;
        {canManageUsers() && (
          &lt;Button 
            type="primary" 
            icon={&lt;PlusOutlined /&gt;} 
            onClick={handleAddUser}
          &gt;
            Add User
          &lt;/Button&gt;
        )}
      &lt;/div&gt;
      
      &lt;Tabs activeKey={activeTab} onChange={handleTabChange}&gt;
        &lt;TabPane 
          tab={&lt;span&gt;&lt;UserOutlined /&gt; Users&lt;/span&gt;} 
          key="users"
        &gt;
          &lt;UserList 
            users={users} 
            roles={roles} 
            teams={teams} 
            loading={loading} 
          /&gt;
        &lt;/TabPane&gt;
        
        {canManageUsers() && (
          &lt;TabPane 
            tab={&lt;span&gt;&lt;LockOutlined /&gt; Roles &amp; Permissions&lt;/span&gt;} 
            key="roles"
          &gt;
            &lt;RoleManager roles={roles} loading={loading} /&gt;
          &lt;/TabPane&gt;
        )}
        
        {canManageUsers() && (
          &lt;TabPane 
            tab={&lt;span&gt;&lt;TeamOutlined /&gt; Teams&lt;/span&gt;} 
            key="teams"
          &gt;
            &lt;TeamManager teams={teams} users={users} loading={loading} /&gt;
          &lt;/TabPane&gt;
        )}
      &lt;/Tabs&gt;
      
      &lt;UserFormModal 
        visible={isModalVisible}
        onClose={() => setIsModalVisible(false)}
        roles={roles}
        teams={teams}
      /&gt;
    &lt;/div&gt;
  );
};</code></pre>
        
        <h4>2. UserList Component</h4>
        <p>
          This component displays a list of users with search, filtering, and pagination capabilities. It also 
          provides actions for editing and deleting users.
        </p>
        
        <p>Key features:</p>
        <ul>
          <li>Tabular display of users</li>
          <li>Search and filtering</li>
          <li>Pagination</li>
          <li>User actions (edit, delete, etc.)</li>
        </ul>
        
        <p>Example implementation:</p>
        <pre><code class="language-typescript">// UserList.tsx
import React, { useState } from 'react';
import { useDispatch } from 'react-redux';
import { Table, Input, Button, Space, Popconfirm, Tag, Select, message } from 'antd';
import { SearchOutlined, EditOutlined, DeleteOutlined, LockOutlined } from '@ant-design/icons';
import { deleteUser, updateUserStatus } from '../services/userService';
import { removeUser, updateUser } from '../store/userSlice';
import { User, Role, Team } from '../types/user';
import UserFormModal from './UserFormModal';

const { Option } = Select;

interface UserListProps {
  users: User[];
  roles: Role[];
  teams: Team[];
  loading: boolean;
}

const UserList: React.FC&lt;UserListProps&gt; = ({ users, roles, teams, loading }) => {
  const dispatch = useDispatch();
  
  const [searchText, setSearchText] = useState('');
  const [editingUser, setEditingUser] = useState&lt;User | null&gt;(null);
  const [isModalVisible, setIsModalVisible] = useState(false);
  
  const handleSearch = (value: string) => {
    setSearchText(value);
  };
  
  const handleEdit = (user: User) => {
    setEditingUser(user);
    setIsModalVisible(true);
  };
  
  const handleDelete = async (userId: string) => {
    try {
      await deleteUser(userId);
      dispatch(removeUser(userId));
      message.success('User deleted successfully');
    } catch (error) {
      console.error('Failed to delete user:', error);
      message.error('Failed to delete user. Please try again.');
    }
  };
  
  const handleStatusChange = async (userId: string, status: string) => {
    try {
      const updatedUser = await updateUserStatus(userId, status);
      dispatch(updateUser(updatedUser));
      message.success(`User status updated to ${status}`);
    } catch (error) {
      console.error('Failed to update user status:', error);
      message.error('Failed to update user status. Please try again.');
    }
  };
  
  const filteredUsers = users.filter(user => {
    const searchLower = searchText.toLowerCase();
    return (
      user.username.toLowerCase().includes(searchLower) ||
      user.email.toLowerCase().includes(searchLower) ||
      user.fullName.toLowerCase().includes(searchLower)
    );
  });
  
  const columns = [
    {
      title: 'Username',
      dataIndex: 'username',
      key: 'username',
      sorter: (a: User, b: User) => a.username.localeCompare(b.username),
    },
    {
      title: 'Full Name',
      dataIndex: 'fullName',
      key: 'fullName',
      sorter: (a: User, b: User) => a.fullName.localeCompare(b.fullName),
    },
    {
      title: 'Email',
      dataIndex: 'email',
      key: 'email',
    },
    {
      title: 'Roles',
      dataIndex: 'roles',
      key: 'roles',
      render: (userRoles: string[]) => (
        &lt;span&gt;
          {userRoles.map(roleId => {
            const role = roles.find(r => r.id === roleId);
            return role ? (
              &lt;Tag color="blue" key={roleId}&gt;
                {role.name}
              &lt;/Tag&gt;
            ) : null;
          })}
        &lt;/span&gt;
      ),
    },
    {
      title: 'Team',
      dataIndex: 'teamId',
      key: 'teamId',
      render: (teamId: string) => {
        const team = teams.find(t => t.id === teamId);
        return team ? team.name : 'No Team';
      },
    },
    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      render: (status: string, record: User) => (
        &lt;Select
          value={status}
          style={{ width: 120 }}
          onChange={(value) => handleStatusChange(record.id, value)}
        &gt;
          &lt;Option value="active"&gt;Active&lt;/Option&gt;
          &lt;Option value="inactive"&gt;Inactive&lt;/Option&gt;
          &lt;Option value="suspended"&gt;Suspended&lt;/Option&gt;
        &lt;/Select&gt;
      ),
    },
    {
      title: 'Actions',
      key: 'actions',
      render: (text: string, record: User) => (
        &lt;Space size="middle"&gt;
          &lt;Button 
            icon={&lt;EditOutlined /&gt;} 
            onClick={() => handleEdit(record)}
            title="Edit User"
          /&gt;
          &lt;Button 
            icon={&lt;LockOutlined /&gt;} 
            onClick={() => console.log('Reset password for', record.id)}
            title="Reset Password"
          /&gt;
          &lt;Popconfirm
            title="Are you sure you want to delete this user?"
            onConfirm={() => handleDelete(record.id)}
            okText="Yes"
            cancelText="No"
          &gt;
            &lt;Button 
              icon={&lt;DeleteOutlined /&gt;} 
              danger
              title="Delete User"
            /&gt;
          &lt;/Popconfirm&gt;
        &lt;/Space&gt;
      ),
    },
  ];
  
  return (
    &lt;div className="user-list-container"&gt;
      &lt;div className="user-list-header"&gt;
        &lt;Input
          placeholder="Search users..."
          prefix={&lt;SearchOutlined /&gt;}
          onChange={(e) => handleSearch(e.target.value)}
          style={{ width: 300 }}
        /&gt;
      &lt;/div&gt;
      
      &lt;Table
        columns={columns}
        dataSource={filteredUsers}
        rowKey="id"
        loading={loading}
        pagination={{ pageSize: 10 }}
      /&gt;
      
      &lt;UserFormModal
        visible={isModalVisible}
        onClose={() => {
          setIsModalVisible(false);
          setEditingUser(null);
        }}
        user={editingUser}
        roles={roles}
        teams={teams}
      /&gt;
    &lt;/div&gt;
  );
};</code></pre>
        
        <h4>3. UserFormModal Component</h4>
        <p>
          This component provides a form for creating and editing user accounts. It includes fields for user 
          information, role assignment, and team membership.
        </p>
        
        <p>Key features:</p>
        <ul>
          <li>User information fields</li>
          <li>Role selection</li>
          <li>Team assignment</li>
          <li>Form validation</li>
        </ul>
        
        <p>Example implementation:</p>
        <pre><code class="language-typescript">// UserFormModal.tsx
import React, { useState, useEffect } from 'react';
import { useDispatch } from 'react-redux';
import { Modal, Form, Input, Select, Button, Switch, message } from 'antd';
import { createUser, updateUser as updateUserApi } from '../services/userService';
import { addUser, updateUser } from '../store/userSlice';
import { User, Role, Team } from '../types/user';

const { Option } = Select;

interface UserFormModalProps {
  visible: boolean;
  onClose: () => void;
  user?: User | null;
  roles: Role[];
  teams: Team[];
}

const UserFormModal: React.FC&lt;UserFormModalProps&gt; = ({ 
  visible, 
  onClose, 
  user, 
  roles, 
  teams 
}) => {
  const dispatch = useDispatch();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  
  // Reset form when modal opens or user changes
  useEffect(() => {
    if (visible) {
      form.resetFields();
      
      if (user) {
        form.setFieldsValue({
          username: user.username,
          email: user.email,
          fullName: user.fullName,
          roles: user.roles,
          teamId: user.teamId,
          isActive: user.status === 'active',
        });
      }
    }
  }, [visible, user, form]);
  
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      setLoading(true);
      
      const userData = {
        ...values,
        status: values.isActive ? 'active' : 'inactive',
      };
      
      if (user) {
        // Update existing user
        const updatedUser = await updateUserApi(user.id, userData);
        dispatch(updateUser(updatedUser));
        message.success('User updated successfully');
      } else {
        // Create new user
        const newUser = await createUser(userData);
        dispatch(addUser(newUser));
        message.success('User created successfully');
      }
      
      onClose();
    } catch (error) {
      console.error('Form submission failed:', error);
      message.error('Failed to save user. Please check the form and try again.');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    &lt;Modal
      title={user ? 'Edit User' : 'Create New User'}
      open={visible}
      onCancel={onClose}
      footer={[
        &lt;Button key="cancel" onClick={onClose}&gt;
          Cancel
        &lt;/Button&gt;,
        &lt;Button 
          key="submit" 
          type="primary" 
          loading={loading} 
          onClick={handleSubmit}
        &gt;
          {user ? 'Update' : 'Create'}
        &lt;/Button&gt;,
      ]}
      width={600}
    &gt;
      &lt;Form
        form={form}
        layout="vertical"
        initialValues={{
          isActive: true,
          roles: [],
        }}
      &gt;
        &lt;Form.Item
          name="username"
          label="Username"
          rules={[
            { required: true, message: 'Please enter a username' },
            { min: 3, message: 'Username must be at least 3 characters' },
          ]}
        &gt;
          &lt;Input placeholder="Enter username" /&gt;
        &lt;/Form.Item&gt;
        
        {!user && (
          &lt;Form.Item
            name="password"
            label="Password"
            rules={[
              { required: true, message: 'Please enter a password' },
              { min: 8, message: 'Password must be at least 8 characters' },
            ]}
          &gt;
            &lt;Input.Password placeholder="Enter password" /&gt;
          &lt;/Form.Item&gt;
        )}
        
        &lt;Form.Item
          name="email"
          label="Email"
          rules={[
            { required: true, message: 'Please enter an email' },
            { type: 'email', message: 'Please enter a valid email' },
          ]}
        &gt;
          &lt;Input placeholder="Enter email" /&gt;
        &lt;/Form.Item&gt;
        
        &lt;Form.Item
          name="fullName"
          label="Full Name"
          rules={[
            { required: true, message: 'Please enter full name' },
          ]}
        &gt;
          &lt;Input placeholder="Enter full name" /&gt;
        &lt;/Form.Item&gt;
        
        &lt;Form.Item
          name="roles"
          label="Roles"
          rules={[
            { required: true, message: 'Please select at least one role' },
          ]}
        &gt;
          &lt;Select
            mode="multiple"
            placeholder="Select roles"
            style={{ width: '100%' }}
          &gt;
            {roles.map(role => (
              &lt;Option key={role.id} value={role.id}&gt;{role.name}&lt;/Option&gt;
            ))}
          &lt;/Select&gt;
        &lt;/Form.Item&gt;
        
        &lt;Form.Item
          name="teamId"
          label="Team"
        &gt;
          &lt;Select
            placeholder="Select team"
            allowClear
            style={{ width: '100%' }}
          &gt;
            {teams.map(team => (
              &lt;Option key={team.id} value={team.id}&gt;{team.name}&lt;/Option&gt;
            ))}
          &lt;/Select&gt;
        &lt;/Form.Item&gt;
        
        &lt;Form.Item
          name="isActive"
          label="Active"
          valuePropName="checked"
        &gt;
          &lt;Switch /&gt;
        &lt;/Form.Item&gt;
      &lt;/Form&gt;
    &lt;/Modal&gt;
  );
};</code></pre>
      </div>
      
      <h2>State Management</h2>
      
      <p>
        The User Management state is managed through a dedicated Redux slice. This slice maintains the state of 
        users, roles, and teams, and provides actions for manipulating this state.
      </p>
      
      <div class="component-card">
        <h3>User State Slice</h3>
        <pre><code class="language-typescript">// userSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { User, Role, Team } from '../types/user';

interface UserState {
  users: User[];
  roles: Role[];
  teams: Team[];
  loading: boolean;
  error: string | null;
}

const initialState: UserState = {
  users: [],
  roles: [],
  teams: [],
  loading: false,
  error: null
};

const userSlice = createSlice({
  name: 'user',
  initialState,
  reducers: {
    setUsers: (state, action: PayloadAction&lt;User[]&gt;) => {
      state.users = action.payload;
    },
    addUser: (state, action: PayloadAction&lt;User&gt;) => {
      state.users.push(action.payload);
    },
    updateUser: (state, action: PayloadAction&lt;User&gt;) => {
      const index = state.users.findIndex(user => user.id === action.payload.id);
      if (index !== -1) {
        state.users[index] = action.payload;
      }
    },
    removeUser: (state, action: PayloadAction&lt;string&gt;) => {
      state.users = state.users.filter(user => user.id !== action.payload);
    },
    setRoles: (state, action: PayloadAction&lt;Role[]&gt;) => {
      state.roles = action.payload;
    },
    addRole: (state, action: PayloadAction&lt;Role&gt;) => {
      state.roles.push(action.payload);
    },
    updateRole: (state, action: PayloadAction&lt;Role&gt;) => {
      const index = state.roles.findIndex(role => role.id === action.payload.id);
      if (index !== -1) {
        state.roles[index] = action.payload;
      }
    },
    removeRole: (state, action: PayloadAction&lt;string&gt;) => {
      state.roles = state.roles.filter(role => role.id !== action.payload);
    },
    setTeams: (state, action: PayloadAction&lt;Team[]&gt;) => {
      state.teams = action.payload;
    },
    addTeam: (state, action: PayloadAction&lt;Team&gt;) => {
      state.teams.push(action.payload);
    },
    updateTeam: (state, action: PayloadAction&lt;Team&gt;) => {
      const index = state.teams.findIndex(team => team.id === action.payload.id);
      if (index !== -1) {
        state.teams[index] = action.payload;
      }
    },
    removeTeam: (state, action: PayloadAction&lt;string&gt;) => {
      state.teams = state.teams.filter(team => team.id !== action.payload);
    },
    setLoading: (state, action: PayloadAction&lt;boolean&gt;) => {
      state.loading = action.payload;
    },
    setError: (state, action: PayloadAction&lt;string | null&gt;) => {
      state.error = action.payload;
    }
  }
});

export const {
  setUsers,
  addUser,
  updateUser,
  removeUser,
  setRoles,
  addRole,
  updateRole,
  removeRole,
  setTeams,
  addTeam,
  updateTeam,
  removeTeam,
  setLoading,
  setError
} = userSlice.actions;

export default userSlice.reducer;</code></pre>
      </div>
      
      <h2>Backend Integration</h2>
      
      <p>
        The User Management frontend communicates with the backend through a set of API services. These services 
        handle operations such as fetching users, creating and updating user accounts, and managing roles and teams.
      </p>
      
      <div class="component-card">
        <h3>User API Service</h3>
        <pre><code class="language-typescript">// userService.ts
import axios from 'axios';
import { API_BASE_URL } from '../config';
import { User, Role, Team } from '../types/user';

const API_URL = `${API_BASE_URL}/users`;

// User operations
export const fetchUsers = async (): Promise&lt;User[]&gt; => {
  const response = await axios.get(`${API_URL}`);
  return response.data;
};

export const fetchUserById = async (userId: string): Promise&lt;User&gt; => {
  const response = await axios.get(`${API_URL}/${userId}`);
  return response.data;
};

export const createUser = async (userData: Omit&lt;User, 'id'&gt;): Promise&lt;User&gt; => {
  const response = await axios.post(`${API_URL}`, userData);
  return response.data;
};

export const updateUser = async (userId: string, userData: Partial&lt;User&gt;): Promise&lt;User&gt; => {
  const response = await axios.put(`${API_URL}/${userId}`, userData);
  return response.data;
};

export const deleteUser = async (userId: string): Promise&lt;void&gt; => {
  await axios.delete(`${API_URL}/${userId}`);
};

export const updateUserStatus = async (userId: string, status: string): Promise&lt;User&gt; => {
  const response = await axios.patch(`${API_URL}/${userId}/status`, { status });
  return response.data;
};

export const resetUserPassword = async (userId: string): Promise&lt;{ temporaryPassword: string }&gt; => {
  const response = await axios.post(`${API_URL}/${userId}/reset-password`);
  return response.data;
};

// Role operations
export const fetchRoles = async (): Promise&lt;Role[]&gt; => {
  const response = await axios.get(`${API_BASE_URL}/roles`);
  return response.data;
};

export const createRole = async (roleData: Omit&lt;Role, 'id'&gt;): Promise&lt;Role&gt; => {
  const response = await axios.post(`${API_BASE_URL}/roles`, roleData);
  return response.data;
};

export const updateRole = async (roleId: string, roleData: Partial&lt;Role&gt;): Promise&lt;Role&gt; => {
  const response = await axios.put(`${API_BASE_URL}/roles/${roleId}`, roleData);
  return response.data;
};

export const deleteRole = async (roleId: string): Promise&lt;void&gt; => {
  await axios.delete(`${API_BASE_URL}/roles/${roleId}`);
};

// Team operations
export const fetchTeams = async (): Promise&lt;Team[]&gt; => {
  const response = await axios.get(`${API_BASE_URL}/teams`);
  return response.data;
};

export const createTeam = async (teamData: Omit&lt;Team, 'id'&gt;): Promise&lt;Team&gt; => {
  const response = await axios.post(`${API_BASE_URL}/teams`, teamData);
  return response.data;
};

export const updateTeam = async (teamId: string, teamData: Partial&lt;Team&gt;): Promise&lt;Team&gt; => {
  const response = await axios.put(`${API_BASE_URL}/teams/${teamId}`, teamData);
  return response.data;
};

export const deleteTeam = async (teamId: string): Promise&lt;void&gt; => {
  await axios.delete(`${API_BASE_URL}/teams/${teamId}`);
};

export const addUserToTeam = async (teamId: string, userId: string): Promise&lt;Team&gt; => {
  const response = await axios.post(`${API_BASE_URL}/teams/${teamId}/members`, { userId });
  return response.data;
};

export const removeUserFromTeam = async (teamId: string, userId: string): Promise&lt;Team&gt; => {
  const response = await axios.delete(`${API_BASE_URL}/teams/${teamId}/members/${userId}`);
  return response.data;
};</code></pre>
      </div>
      
      <h2>Types</h2>
      
      <p>
        The User Management feature uses TypeScript interfaces to define the structure of users, roles, and teams.
      </p>
      
      <div class="component-card">
        <h3>User Types</h3>
        <pre><code class="language-typescript">// types/user.ts
export interface User {
  id: string;
  username: string;
  email: string;
  fullName: string;
  roles: string[]; // Array of role IDs
  teamId?: string;
  status: 'active' | 'inactive' | 'suspended';
  lastLogin?: string;
  createdAt: string;
  updatedAt: string;
}

export interface Role {
  id: string;
  name: string;
  description: string;
  permissions: string[];
  createdAt: string;
  updatedAt: string;
}

export interface Team {
  id: string;
  name: string;
  description: string;
  members: string[]; // Array of user IDs
  leaderId?: string;
  createdAt: string;
  updatedAt: string;
}

export interface Permission {
  id: string;
  name: string;
  description: string;
  category: string;
}</code></pre>
      </div>
      
      <h2>Role-Based Access Control</h2>
      
      <p>
        The User Management system implements role-based access control (RBAC) to manage permissions. This allows 
        administrators to define roles with specific permissions and assign these roles to users.
      </p>
      
      <div class="component-card">
        <h3>Role Manager Component</h3>
        <pre><code class="language-typescript">// RoleManager.tsx
import React, { useState } from 'react';
import { useDispatch } from 'react-redux';
import { Table, Button, Space, Popconfirm, Tag, message, Modal, Form, Input, Select, Checkbox } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';
import { createRole, updateRole as updateRoleApi, deleteRole } from '../services/userService';
import { addRole, updateRole, removeRole } from '../store/userSlice';
import { Role, Permission } from '../types/user';

const { Option } = Select;

interface RoleManagerProps {
  roles: Role[];
  loading: boolean;
}

const RoleManager: React.FC&lt;RoleManagerProps&gt; = ({ roles, loading }) => {
  const dispatch = useDispatch();
  
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [editingRole, setEditingRole] = useState&lt;Role | null&gt;(null);
  const [form] = Form.useForm();
  
  // Sample permissions - in a real app, these would come from the backend
  const permissions: Permission[] = [
    { id: 'view_users', name: 'View Users', description: 'Can view user list', category: 'Users' },
    { id: 'manage_users', name: 'Manage Users', description: 'Can create, edit, and delete users', category: 'Users' },
    { id: 'view_roles', name: 'View Roles', description: 'Can view roles', category: 'Roles' },
    { id: 'manage_roles', name: 'Manage Roles', description: 'Can create, edit, and delete roles', category: 'Roles' },
    { id: 'view_teams', name: 'View Teams', description: 'Can view teams', category: 'Teams' },
    { id: 'manage_teams', name: 'Manage Teams', description: 'Can create, edit, and delete teams', category: 'Teams' },
    // Add more permissions as needed
  ];
  
  const handleAddRole = () => {
    setEditingRole(null);
    form.resetFields();
    setIsModalVisible(true);
  };
  
  const handleEditRole = (role: Role) => {
    setEditingRole(role);
    form.setFieldsValue({
      name: role.name,
      description: role.description,
      permissions: role.permissions,
    });
    setIsModalVisible(true);
  };
  
  const handleDeleteRole = async (roleId: string) => {
    try {
      await deleteRole(roleId);
      dispatch(removeRole(roleId));
      message.success('Role deleted successfully');
    } catch (error) {
      console.error('Failed to delete role:', error);
      message.error('Failed to delete role. Please try again.');
    }
  };
  
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      
      if (editingRole) {
        // Update existing role
        const updatedRole = await updateRoleApi(editingRole.id, values);
        dispatch(updateRole(updatedRole));
        message.success('Role updated successfully');
      } else {
        // Create new role
        const newRole = await createRole(values);
        dispatch(addRole(newRole));
        message.success('Role created successfully');
      }
      
      setIsModalVisible(false);
    } catch (error) {
      console.error('Form submission failed:', error);
      message.error('Failed to save role. Please check the form and try again.');
    }
  };
  
  const columns = [
    {
      title: 'Role Name',
      dataIndex: 'name',
      key: 'name',
      sorter: (a: Role, b: Role) => a.name.localeCompare(b.name),
    },
    {
      title: 'Description',
      dataIndex: 'description',
      key: 'description',
    },
    {
      title: 'Permissions',
      dataIndex: 'permissions',
      key: 'permissions',
      render: (permissionIds: string[]) => (
        &lt;span&gt;
          {permissionIds.map(permId => {
            const permission = permissions.find(p => p.id === permId);
            return permission ? (
              &lt;Tag color="green" key={permId}&gt;
                {permission.name}
              &lt;/Tag&gt;
            ) : null;
          })}
        &lt;/span&gt;
      ),
    },
    {
      title: 'Actions',
      key: 'actions',
      render: (text: string, record: Role) => (
        &lt;Space size="middle"&gt;
          &lt;Button 
            icon={&lt;EditOutlined /&gt;} 
            onClick={() => handleEditRole(record)}
            title="Edit Role"
          /&gt;
          &lt;Popconfirm
            title="Are you sure you want to delete this role?"
            onConfirm={() => handleDeleteRole(record.id)}
            okText="Yes"
            cancelText="No"
          &gt;
            &lt;Button 
              icon={&lt;DeleteOutlined /&gt;} 
              danger
              title="Delete Role"
            /&gt;
          &lt;/Popconfirm&gt;
        &lt;/Space&gt;
      ),
    },
  ];
  
  return (
    &lt;div className="role-manager-container"&gt;
      &lt;div className="role-manager-header"&gt;
        &lt;Button 
          type="primary" 
          icon={&lt;PlusOutlined /&gt;} 
          onClick={handleAddRole}
        &gt;
          Add Role
        &lt;/Button&gt;
      &lt;/div&gt;
      
      &lt;Table
        columns={columns}
        dataSource={roles}
        rowKey="id"
        loading={loading}
        pagination={{ pageSize: 10 }}
      /&gt;
      
      &lt;Modal
        title={editingRole ? 'Edit Role' : 'Create New Role'}
        open={isModalVisible}
        onCancel={() => setIsModalVisible(false)}
        onOk={handleSubmit}
        width={600}
      &gt;
        &lt;Form
          form={form}
          layout="vertical"
        &gt;
          &lt;Form.Item
            name="name"
            label="Role Name"
            rules={[{ required: true, message: 'Please enter a role name' }]}
          &gt;
            &lt;Input placeholder="Enter role name" /&gt;
          &lt;/Form.Item&gt;
          
          &lt;Form.Item
            name="description"
            label="Description"
          &gt;
            &lt;Input.TextArea placeholder="Enter role description" rows={3} /&gt;
          &lt;/Form.Item&gt;
          
          &lt;Form.Item
            name="permissions"
            label="Permissions"
            rules={[{ required: true, message: 'Please select at least one permission' }]}
          &gt;
            &lt;Checkbox.Group style={{ width: '100%' }}&gt;
              {Object.entries(
                permissions.reduce((acc, perm) => {
                  if (!acc[perm.category]) {
                    acc[perm.category] = [];
                  }
                  acc[perm.category].push(perm);
                  return acc;
                }, {} as Record&lt;string, Permission[]&gt;)
              ).map(([category, perms]) => (
                &lt;div key={category} className="permission-category"&gt;
                  &lt;h4&gt;{category}&lt;/h4&gt;
                  {perms.map(perm => (
                    &lt;Checkbox key={perm.id} value={perm.id}&gt;
                      {perm.name}
                      &lt;span className="permission-description"&gt;{perm.description}&lt;/span&gt;
                    &lt;/Checkbox&gt;
                  ))}
                &lt;/div&gt;
              ))}
            &lt;/Checkbox.Group&gt;
          &lt;/Form.Item&gt;
        &lt;/Form&gt;
      &lt;/Modal&gt;
    &lt;/div&gt;
  );
};</code></pre>
      </div>
      
      <h2>Team Management</h2>
      
      <p>
        The User Management system includes team management functionality, allowing administrators to organize 
        users into teams and departments.
      </p>
      
      <div class="component-card">
        <h3>Team Manager Component</h3>
        <pre><code class="language-typescript">// TeamManager.tsx
import React, { useState } from 'react';
import { useDispatch } from 'react-redux';
import { Table, Button, Space, Popconfirm, Avatar, message, Modal, Form, Input, Select, List } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, UserOutlined, UserAddOutlined } from '@ant-design/icons';
import { createTeam, updateTeam as updateTeamApi, deleteTeam, addUserToTeam, removeUserFromTeam } from '../services/userService';
import { addTeam, updateTeam, removeTeam } from '../store/userSlice';
import { Team, User } from '../types/user';

const { Option } = Select;

interface TeamManagerProps {
  teams: Team[];
  users: User[];
  loading: boolean;
}

const TeamManager: React.FC&lt;TeamManagerProps&gt; = ({ teams, users, loading }) => {
  const dispatch = useDispatch();
  
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [isMemberModalVisible, setIsMemberModalVisible] = useState(false);
  const [editingTeam, setEditingTeam] = useState&lt;Team | null&gt;(null);
  const [selectedTeam, setSelectedTeam] = useState&lt;Team | null&gt;(null);
  const [form] = Form.useForm();
  
  const handleAddTeam = () => {
    setEditingTeam(null);
    form.resetFields();
    setIsModalVisible(true);
  };
  
  const handleEditTeam = (team: Team) => {
    setEditingTeam(team);
    form.setFieldsValue({
      name: team.name,
      description: team.description,
      leaderId: team.leaderId,
    });
    setIsModalVisible(true);
  };
  
  const handleDeleteTeam = async (teamId: string) => {
    try {
      await deleteTeam(teamId);
      dispatch(removeTeam(teamId));
      message.success('Team deleted successfully');
    } catch (error) {
      console.error('Failed to delete team:', error);
      message.error('Failed to delete team. Please try again.');
    }
  };
  
  const handleManageMembers = (team: Team) => {
    setSelectedTeam(team);
    setIsMemberModalVisible(true);
  };
  
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      
      if (editingTeam) {
        // Update existing team
        const updatedTeam = await updateTeamApi(editingTeam.id, values);
        dispatch(updateTeam(updatedTeam));
        message.success('Team updated successfully');
      } else {
        // Create new team
        const newTeam = await createTeam({ ...values, members: [] });
        dispatch(addTeam(newTeam));
        message.success('Team created successfully');
      }
      
      setIsModalVisible(false);
    } catch (error) {
      console.error('Form submission failed:', error);
      message.error('Failed to save team. Please check the form and try again.');
    }
  };
  
  const handleAddMember = async (userId: string) => {
    if (!selectedTeam) return;
    
    try {
      const updatedTeam = await addUserToTeam(selectedTeam.id, userId);
      dispatch(updateTeam(updatedTeam));
      message.success('User added to team successfully');
    } catch (error) {
      console.error('Failed to add user to team:', error);
      message.error('Failed to add user to team. Please try again.');
    }
  };
  
  const handleRemoveMember = async (userId: string) => {
    if (!selectedTeam) return;
    
    try {
      const updatedTeam = await removeUserFromTeam(selectedTeam.id, userId);
      dispatch(updateTeam(updatedTeam));
      message.success('User removed from team successfully');
    } catch (error) {
      console.error('Failed to remove user from team:', error);
      message.error('Failed to remove user from team. Please try again.');
    }
  };
  
  const columns = [
    {
      title: 'Team Name',
      dataIndex: 'name',
      key: 'name',
      sorter: (a: Team, b: Team) => a.name.localeCompare(b.name),
    },
    {
      title: 'Description',
      dataIndex: 'description',
      key: 'description',
    },
    {
      title: 'Team Lead',
      dataIndex: 'leaderId',
      key: 'leaderId',
      render: (leaderId: string) => {
        const leader = users.find(user => user.id === leaderId);
        return leader ? leader.fullName : 'No Leader';
      },
    },
    {
      title: 'Members',
      dataIndex: 'members',
      key: 'members',
      render: (members: string[]) => `${members.length} members`,
    },
    {
      title: 'Actions',
      key: 'actions',
      render: (text: string, record: Team) => (
        &lt;Space size="middle"&gt;
          &lt;Button 
            icon={&lt;UserAddOutlined /&gt;} 
            onClick={() => handleManageMembers(record)}
            title="Manage Members"
          /&gt;
          &lt;Button 
            icon={&lt;EditOutlined /&gt;} 
            onClick={() => handleEditTeam(record)}
            title="Edit Team"
          /&gt;
          &lt;Popconfirm
            title="Are you sure you want to delete this team?"
            onConfirm={() => handleDeleteTeam(record.id)}
            okText="Yes"
            cancelText="No"
          &gt;
            &lt;Button 
              icon={&lt;DeleteOutlined /&gt;} 
              danger
              title="Delete Team"
            /&gt;
          &lt;/Popconfirm&gt;
        &lt;/Space&gt;
      ),
    },
  ];
  
  return (
    &lt;div className="team-manager-container"&gt;
      &lt;div className="team-manager-header"&gt;
        &lt;Button 
          type="primary" 
          icon={&lt;PlusOutlined /&gt;} 
          onClick={handleAddTeam}
        &gt;
          Add Team
        &lt;/Button&gt;
      &lt;/div&gt;
      
      &lt;Table
        columns={columns}
        dataSource={teams}
        rowKey="id"
        loading={loading}
        pagination={{ pageSize: 10 }}
      /&gt;
      
      {/* Team Form Modal */}
      &lt;Modal
        title={editingTeam ? 'Edit Team' : 'Create New Team'}
        open={isModalVisible}
        onCancel={() => setIsModalVisible(false)}
        onOk={handleSubmit}
        width={600}
      &gt;
        &lt;Form
          form={form}
          layout="vertical"
        &gt;
          &lt;Form.Item
            name="name"
            label="Team Name"
            rules={[{ required: true, message: 'Please enter a team name' }]}
          &gt;
            &lt;Input placeholder="Enter team name" /&gt;
          &lt;/Form.Item&gt;
          
          &lt;Form.Item
            name="description"
            label="Description"
          &gt;
            &lt;Input.TextArea placeholder="Enter team description" rows={3} /&gt;
          &lt;/Form.Item&gt;
          
          &lt;Form.Item
            name="leaderId"
            label="Team Lead"
          &gt;
            &lt;Select
              placeholder="Select team lead"
              allowClear
              style={{ width: '100%' }}
            &gt;
              {users.map(user => (
                &lt;Option key={user.id} value={user.id}&gt;{user.fullName}&lt;/Option&gt;
              ))}
            &lt;/Select&gt;
          &lt;/Form.Item&gt;
        &lt;/Form&gt;
      &lt;/Modal&gt;
      
      {/* Team Members Modal */}
      &lt;Modal
        title={`Manage Team Members: ${selectedTeam?.name || ''}`}
        open={isMemberModalVisible}
        onCancel={() => setIsMemberModalVisible(false)}
        footer={null}
        width={700}
      &gt;
        &lt;div className="team-members-container"&gt;
          &lt;div className="team-members-section"&gt;
            &lt;h3&gt;Current Members&lt;/h3&gt;
            {selectedTeam && (
              &lt;List
                dataSource={users.filter(user => selectedTeam.members.includes(user.id))}
                renderItem={user => (
                  &lt;List.Item
                    actions={[
                      &lt;Button 
                        key="remove" 
                        danger 
                        onClick={() => handleRemoveMember(user.id)}
                      &gt;
                        Remove
                      &lt;/Button&gt;
                    ]}
                  &gt;
                    &lt;List.Item.Meta
                      avatar={&lt;Avatar icon={&lt;UserOutlined /&gt;} /&gt;}
                      title={user.fullName}
                      description={user.email}
                    /&gt;
                  &lt;/List.Item&gt;
                )}
              /&gt;
            )}
          &lt;/div&gt;
          
          &lt;div className="team-members-section"&gt;
            &lt;h3&gt;Add Members&lt;/h3&gt;
            {selectedTeam && (
              &lt;List
                dataSource={users.filter(user => !selectedTeam.members.includes(user.id))}
                renderItem={user => (
                  &lt;List.Item
                    actions={[
                      &lt;Button 
                        key="add" 
                        type="primary" 
                        onClick={() => handleAddMember(user.id)}
                      &gt;
                        Add
                      &lt;/Button&gt;
                    ]}
                  &gt;
                    &lt;List.Item.Meta
                      avatar={&lt;Avatar icon={&lt;UserOutlined /&gt;} /&gt;}
                      title={user.fullName}
                      description={user.email}
                    /&gt;
                  &lt;/List.Item&gt;
                )}
              /&gt;
            )}
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Modal&gt;
    &lt;/div&gt;
  );
};</code></pre>
      </div>
      
      <h2>Styling</h2>
      
      <p>
        The User Management feature is styled using a combination of Ant Design components and custom CSS. The styling 
        focuses on providing a clean, intuitive interface that makes it easy to manage users, roles, and teams.
      </p>
      
      <div class="component-card">
        <h3>Key Styling Features</h3>
        <ul>
          <li>Responsive layout that adapts to different screen sizes</li>
          <li>Clean, tabular presentation of user data</li>
          <li>Intuitive forms for creating and editing users, roles, and teams</li>
          <li>Visual indicators for user status and roles</li>
          <li>Consistent spacing and alignment</li>
        </ul>
      </div>
    </section>
  </main>
  
  <script src="../../assets/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script>
    // Initialize syntax highlighting and mermaid diagrams
    document.addEventListener('DOMContentLoaded', (event) => {
      Prism.highlightAll();
      mermaid.initialize({ startOnLoad: true });
    });
  </script>
</body>
</html>