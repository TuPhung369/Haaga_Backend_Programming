<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backend Structure - TuPhung Project Documentation</title>
  <link rel="stylesheet" href="../../css/style.css">
  <!-- Mermaid for flowcharts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.0/dist/mermaid.min.js"></script>
  <!-- Prism for code highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
</head>
<body>
  <button class="menu-toggle">☰</button>
  
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>TuPhung Project</h1>
    </div>
    
    <nav class="sidebar-nav">
      <div class="sidebar-section">
        <div class="sidebar-section-title">Overview</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="../../index.html" class="sidebar-subnav-link">Introduction</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../architecture.html" class="sidebar-subnav-link">Architecture</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../tech-stack.html" class="sidebar-subnav-link">Tech Stack</a>
          </li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">Frontend</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="../frontend/structure.html" class="sidebar-subnav-link">Project Structure</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/auth.html" class="sidebar-subnav-link">Authentication</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/user-management.html" class="sidebar-subnav-link">User Management</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/chat.html" class="sidebar-subnav-link">Chat System</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/kanban.html" class="sidebar-subnav-link">Kanban Board</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/calendar.html" class="sidebar-subnav-link">Calendar</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/ai-assistants.html" class="sidebar-subnav-link">AI Assistants</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/language-ai.html" class="sidebar-subnav-link">Language AI</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="../frontend/state-management.html" class="sidebar-subnav-link">State Management</a>
          </li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">Backend</div>
        <ul class="sidebar-subnav">
          <li class="sidebar-subnav-item">
            <a href="structure.html" class="sidebar-subnav-link active">Project Structure</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="auth.html" class="sidebar-subnav-link">Authentication & Security</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="user-management.html" class="sidebar-subnav-link">User Management</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="database.html" class="sidebar-subnav-link">Database Design</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="api.html" class="sidebar-subnav-link">API Endpoints</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="websockets.html" class="sidebar-subnav-link">WebSockets</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="speech-processing.html" class="sidebar-subnav-link">Speech Processing</a>
          </li>
          <li class="sidebar-subnav-item">
            <a href="exception-handling.html" class="sidebar-subnav-link">Exception Handling</a>
          </li>
        </ul>
      </div>
    </nav>
  </aside>
  
  <main class="main-content">
    <header class="content-header">
      <h1>Backend Project Structure</h1>
      <p>Detailed overview of the backend project organization, architecture, and key components.</p>
    </header>
    
    <section>
      <h2>Project Overview</h2>
      <p>
        The backend of the TuPhung Project is built with Spring Boot, following a layered architecture with 
        clear separation of concerns. The application provides RESTful APIs, WebSocket endpoints, and integrates 
        with various services including speech processing and AI capabilities.
      </p>
      
      <div class="component-card">
        <h3>Directory Structure</h3>
        <pre><code class="language-plaintext">study/study/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── database/
│   │   │           └── study/
│   │   │               ├── config/
│   │   │               ├── configuration/
│   │   │               ├── controller/
│   │   │               ├── dto/
│   │   │               ├── entity/
│   │   │               ├── enums/
│   │   │               ├── exception/
│   │   │               ├── interfaces/
│   │   │               ├── mapper/
│   │   │               ├── repository/
│   │   │               ├── security/
│   │   │               ├── service/
│   │   │               ├── util/
│   │   │               ├── validator/
│   │   │               └── StudyApplication.java
│   │   └── resources/
│   │       ├── application.yaml
│   │       ├── application-dev.yaml
│   │       ├── application-aws.yaml
│   │       ├── application-google.yaml
│   │       ├── data.sql
│   │       ├── schema.sql
│   │       ├── db/
│   │       ├── static/
│   │       └── templates/
│   └── test/
│       ├── java/
│       │   └── com/
│       │       └── database/
│       │           └── study/
│       └── resources/
│           └── application-test.properties
├── pom.xml
├── mvnw
├── mvnw.cmd
└── README_BE.md</code></pre>
      </div>
      
      <h2>Key Directories and Files</h2>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/controller/</h3>
        <p>
          Contains REST controllers that handle HTTP requests and define API endpoints.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/controller/
├── AuthController.java
├── CalendarController.java
├── ChatController.java
├── EmailVerificationController.java
├── KanbanController.java
├── LanguageController.java
├── PermissionController.java
├── RoleController.java
├── SpeechController.java
├── TotpController.java
├── UserController.java
└── WebSocketController.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/service/</h3>
        <p>
          Contains service classes that implement business logic and orchestrate operations.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/service/
├── AuthService.java
├── CalendarService.java
├── ChatService.java
├── EmailOtpService.java
├── EmailService.java
├── EmailVerificationService.java
├── KanbanService.java
├── LanguageService.java
├── PermissionService.java
├── RoleService.java
├── SpeechService.java
├── TotpService.java
├── UserService.java
└── WebSocketService.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/entity/</h3>
        <p>
          Contains JPA entity classes that map to database tables.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/entity/
├── BaseEntity.java
├── CalendarEvent.java
├── ChatMessage.java
├── EmailOtp.java
├── EmailVerification.java
├── KanbanBoard.java
├── KanbanColumn.java
├── KanbanTask.java
├── Permission.java
├── Role.java
├── User.java
├── UserPermission.java
├── UserRole.java
└── UserTotp.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/repository/</h3>
        <p>
          Contains Spring Data JPA repositories for database operations.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/repository/
├── CalendarEventRepository.java
├── ChatMessageRepository.java
├── EmailOtpRepository.java
├── EmailVerificationRepository.java
├── KanbanBoardRepository.java
├── KanbanColumnRepository.java
├── KanbanTaskRepository.java
├── PermissionRepository.java
├── RoleRepository.java
├── UserPermissionRepository.java
├── UserRepository.java
├── UserRoleRepository.java
└── UserTotpRepository.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/dto/</h3>
        <p>
          Contains Data Transfer Objects (DTOs) used for API request and response payloads.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/dto/
├── ApiResponse.java
├── AuthRequest.java
├── AuthResponse.java
├── CalendarEventDTO.java
├── ChatMessageDTO.java
├── EmailVerificationDTO.java
├── KanbanBoardDTO.java
├── KanbanColumnDTO.java
├── KanbanTaskDTO.java
├── PermissionDTO.java
├── RoleDTO.java
├── TotpSetupDTO.java
├── UserDTO.java
└── UserRegistrationDTO.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/security/</h3>
        <p>
          Contains security-related classes for authentication, authorization, and JWT handling.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/security/
├── GoogleTokenValidation.java
├── JwtTokenFilter.java
├── JwtTokenProvider.java
├── JwtUtils.java
└── TokenSecurity.java</code></pre>
      </div>
      
      <div class="component-card">
        <h3>src/main/java/com/database/study/config/</h3>
        <p>
          Contains configuration classes for Spring Boot application.
        </p>
        <pre><code class="language-plaintext">src/main/java/com/database/study/config/
├── AsyncConfig.java
├── CorsConfig.java
├── EmailConfig.java
├── OAuth2Config.java
├── SecurityConfig.java
├── SpeechConfig.java
├── SwaggerConfig.java
└── WebSocketConfig.java</code></pre>
      </div>
      
      <h2>Application Structure</h2>
      
      <div class="diagram-container">
        <div class="diagram-title">Backend Application Structure</div>
        <div class="mermaid">
          graph TD
            Client[Client Requests] --> Controllers[REST Controllers]
            WSClient[WebSocket Clients] --> WSController[WebSocket Controller]
            
            Controllers --> Services[Service Layer]
            WSController --> Services
            
            Services --> Repositories[Repository Layer]
            Services --> ExternalServices[External Services]
            
            Repositories --> Entities[Entity Models]
            Repositories --> DB[(Database)]
            
            ExternalServices --> EmailService[Email Service]
            ExternalServices --> SpeechService[Speech Processing]
            ExternalServices --> OAuth2Service[OAuth2 Service]
            
            subgraph Security Layer
              SecurityFilters[Security Filters]
              JwtProvider[JWT Provider]
              AuthenticationManager[Authentication Manager]
              UserDetailsService[User Details Service]
              PasswordEncoder[Password Encoder]
            end
            
            Controllers --> SecurityFilters
            WSController --> SecurityFilters
            Controllers --> DTOs[Data Transfer Objects]
            Services --> DTOs
            
            subgraph Configuration
              AppConfig[Application Config]
              SecurityConfig[Security Config]
              WebSocketConfig[WebSocket Config]
              AsyncConfig[Async Config]
              SwaggerConfig[Swagger Config]
            end
        </div>
      </div>
      
      <h2>Key Configuration Files</h2>
      
      <div class="component-card">
        <h3>pom.xml</h3>
        <p>
          Maven Project Object Model file that defines project dependencies and build configuration.
        </p>
        <pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.5&lt;/version&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;
    
    &lt;groupId&gt;com.database&lt;/groupId&gt;
    &lt;artifactId&gt;study&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;study&lt;/name&gt;
    &lt;description&gt;TuPhung Project Backend&lt;/description&gt;
    
    &lt;properties&gt;
        &lt;java.version&gt;17&lt;/java.version&gt;
        &lt;jjwt.version&gt;0.11.5&lt;/jjwt.version&gt;
        &lt;mapstruct.version&gt;1.5.3.Final&lt;/mapstruct.version&gt;
        &lt;lombok.version&gt;1.18.24&lt;/lombok.version&gt;
        &lt;springdoc.version&gt;1.6.12&lt;/springdoc.version&gt;
    &lt;/properties&gt;
    
    &lt;dependencies&gt;
        &lt;!-- Spring Boot Starters --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-mail&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Database --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
            &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        
        &lt;!-- JWT --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
            &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;
            &lt;version&gt;${jjwt.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
            &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;
            &lt;version&gt;${jjwt.version}&lt;/version&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
            &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt;
            &lt;version&gt;${jjwt.version}&lt;/version&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Lombok and MapStruct --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;${lombok.version}&lt;/version&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;
            &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;
            &lt;version&gt;${mapstruct.version}&lt;/version&gt;
        &lt;/dependency&gt;
        
        &lt;!-- API Documentation --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springdoc&lt;/groupId&gt;
            &lt;artifactId&gt;springdoc-openapi-ui&lt;/artifactId&gt;
            &lt;version&gt;${springdoc.version}&lt;/version&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Testing --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;excludes&gt;
                        &lt;exclude&gt;
                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
                        &lt;/exclude&gt;
                    &lt;/excludes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;source&gt;${java.version}&lt;/source&gt;
                    &lt;target&gt;${java.version}&lt;/target&gt;
                    &lt;annotationProcessorPaths&gt;
                        &lt;path&gt;
                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
                            &lt;version&gt;${lombok.version}&lt;/version&gt;
                        &lt;/path&gt;
                        &lt;path&gt;
                            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;
                            &lt;artifactId&gt;mapstruct-processor&lt;/artifactId&gt;
                            &lt;version&gt;${mapstruct.version}&lt;/version&gt;
                        &lt;/path&gt;
                    &lt;/annotationProcessorPaths&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
      </div>
      
      <div class="component-card">
        <h3>application.yaml</h3>
        <p>
          Main configuration file for the Spring Boot application.
        </p>
        <pre><code class="language-yaml">spring:
  profiles:
    active: dev
  
  datasource:
    url: jdbc:postgresql://localhost:5432/tuphung_db
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
  
  mail:
    host: smtp.gmail.com
    port: 587
    username: ${MAIL_USERNAME}
    password: ${MAIL_PASSWORD}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
  
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            redirect-uri: "{baseUrl}/oauth2/callback/{registrationId}"
            scope:
              - email
              - profile
          facebook:
            client-id: ${FACEBOOK_CLIENT_ID}
            client-secret: ${FACEBOOK_CLIENT_SECRET}
            redirect-uri: "{baseUrl}/oauth2/callback/{registrationId}"
            scope:
              - email
              - public_profile
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
            redirect-uri: "{baseUrl}/oauth2/callback/{registrationId}"
            scope:
              - user:email
              - read:user

server:
  port: 8080
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/plain,text/css,application/javascript

security:
  jwt:
    token:
      secret-key: ${JWT_SECRET:defaultSecretKeyForDevelopmentEnvironmentOnly}
      expire-length: 3600000 # 1 hour in milliseconds
      refresh-expire-length: 86400000 # 24 hours in milliseconds

app:
  cors:
    allowed-origins: http://localhost:3000,http://localhost:8080
  
  email:
    from: noreply@tuphung-project.com
    verification:
      expiration-hours: 24
    otp:
      expiration-minutes: 5
  
  totp:
    issuer: TuPhung Project
    window-size: 1
  
  recaptcha:
    secret: ${RECAPTCHA_SECRET}
    threshold: 0.5
  
  account-locking:
    max-failed-attempts: 5
    lock-time-minutes: 30

logging:
  level:
    root: INFO
    com.database.study: DEBUG
    org.springframework.security: INFO
    org.springframework.web: INFO
    org.hibernate: INFO</code></pre>
      </div>
      
      <h2>Main Application Entry Point</h2>
      
      <div class="component-card">
        <h3>StudyApplication.java</h3>
        <p>
          The main entry point of the Spring Boot application.
        </p>
        <pre><code class="language-java">package com.database.study;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableAsync
@EnableScheduling
public class StudyApplication {

    public static void main(String[] args) {
        SpringApplication.run(StudyApplication.class, args);
    }
}</code></pre>
      </div>
      
      <h2>Key Configuration Classes</h2>
      
      <div class="component-card">
        <h3>SecurityConfig.java</h3>
        <p>
          Configures Spring Security for the application.
        </p>
        <pre><code class="language-java">package com.database.study.config;

import com.database.study.security.JwtTokenFilter;
import com.database.study.security.JwtTokenProvider;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    private final JwtTokenProvider jwtTokenProvider;
    private final UserDetailsService userDetailsService;

    public SecurityConfig(JwtTokenProvider jwtTokenProvider, UserDetailsService userDetailsService) {
        this.jwtTokenProvider = jwtTokenProvider;
        this.userDetailsService = userDetailsService;
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // Disable CSRF
        http.csrf().disable();
        
        // No session will be created or used by Spring Security
        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
        
        // Entry points
        http.authorizeRequests()
            .antMatchers("/api/auth/**").permitAll()
            .antMatchers("/api/public/**").permitAll()
            .antMatchers("/oauth2/**").permitAll()
            .antMatchers("/login/**").permitAll()
            .antMatchers("/v3/api-docs/**", "/swagger-ui/**", "/swagger-ui.html").permitAll()
            // Disallow everything else
            .anyRequest().authenticated();
        
        // Apply JWT filter
        http.addFilterBefore(new JwtTokenFilter(jwtTokenProvider), UsernamePasswordAuthenticationFilter.class);
    }

    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }
}</code></pre>
      </div>
      
      <div class="component-card">
        <h3>WebSocketConfig.java</h3>
        <p>
          Configures WebSocket endpoints and message brokers.
        </p>
        <pre><code class="language-java">package com.database.study.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.ChannelRegistration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    private final WebSocketAuthInterceptor webSocketAuthInterceptor;

    public WebSocketConfig(WebSocketAuthInterceptor webSocketAuthInterceptor) {
        this.webSocketAuthInterceptor = webSocketAuthInterceptor;
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic", "/queue");
        config.setApplicationDestinationPrefixes("/app");
        config.setUserDestinationPrefix("/user");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOrigins("http://localhost:3000")
                .withSockJS();
    }

    @Override
    public void configureClientInboundChannel(ChannelRegistration registration) {
        registration.interceptors(webSocketAuthInterceptor);
    }
}</code></pre>
      </div>
      
      <h2>Development Workflow</h2>
      
      <div class="component-card">
        <h3>Build Process</h3>
        <p>
          The project uses Maven for dependency management and build automation.
        </p>
        <ul>
          <li><strong>Build:</strong> <code>mvn clean install</code> - Builds the project and installs it to the local repository</li>
          <li><strong>Run:</strong> <code>mvn spring-boot:run</code> - Runs the Spring Boot application</li>
          <li><strong>Package:</strong> <code>mvn package</code> - Creates a JAR file for deployment</li>
          <li><strong>Test:</strong> <code>mvn test</code> - Runs unit tests</li>
        </ul>
      </div>
      
      <div class="component-card">
        <h3>Code Organization Principles</h3>
        <ul>
          <li><strong>Layered Architecture:</strong> Clear separation between controllers, services, and repositories</li>
          <li><strong>DTO Pattern:</strong> Data Transfer Objects for API communication</li>
          <li><strong>Repository Pattern:</strong> Spring Data JPA repositories for database access</li>
          <li><strong>Service Layer:</strong> Business logic encapsulated in service classes</li>
          <li><strong>Dependency Injection:</strong> Spring's IoC container for managing dependencies</li>
          <li><strong>Exception Handling:</strong> Global exception handling with @ControllerAdvice</li>
        </ul>
      </div>
      
      <h2>Related Documentation</h2>
      <ul>
        <li><a href="../architecture.html">Architecture Overview</a> - High-level architecture of the entire application</li>
        <li><a href="auth.html">Authentication & Security</a> - Details about the authentication system</li>
        <li><a href="database.html">Database Design</a> - Information about the database schema</li>
        <li><a href="api.html">API Endpoints</a> - Documentation of REST API endpoints</li>
        <li><a href="../frontend/structure.html">Frontend Structure</a> - Structure of the frontend application</li>
      </ul>
    </section>
  </main>
  
  <script src="../../assets/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
</body>
</html>